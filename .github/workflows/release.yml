name: Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: "Type of release version bump"
        required: true
        type: choice
        default: patch
        options:
          - major
          - minor
          - patch
          - post

env:
  UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}
  GO_VERSION: '1.25.3'  # Versi Golang terkini
  PYTHON_VERSION: "3.11"

jobs:
  bump-version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.bump.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: Install uv
        uses: astral-sh/setup-uv@v5
      - name: Install bump-my-version
        run: uv pip install bump-my-version
      - name: Bump version
        id: bump
        run: |
          case "${{ github.event.inputs.version_type }}" in
            major) bump-my-version bump major ;;
            minor) bump-my-version bump minor ;;
            patch) bump-my-version bump patch ;;
            post) bump-my-version bump post ;;
          esac
          echo "version=$(bump-my-version show current_version)" >> $GITHUB_OUTPUT
      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore(release): bump version to ${{ steps.bump.outputs.version }}"
          git push origin master
          git push origin --tags

  android:
    needs: bump-version
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
        fetch-tags: true
    - uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Install uv
      uses: astral-sh/setup-uv@v5
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          **/.venv
        key: ${{ runner.os }}-${{ hashFiles('**/uv.lock') }}
    - name: Install dependencies
      run: |
        uv sync --dev
        uv run task version neonize --set-version ${{ needs.bump-version.outputs.new_version }}
        uv run task version goneonize --set-version ${{ needs.bump-version.outputs.new_version }}
    - name: Setup Android NDK
      run: |
        wget https://dl.google.com/android/repository/android-ndk-r26b-linux.zip -q
        unzip -q android-ndk-r26b-linux.zip
        echo "ANDROID_NDK_HOME=$(pwd)/android-ndk-r26b" >> $GITHUB_ENV
        echo "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH
    - name: Build Android binaries
      env:
        CGO_ENABLED: 1
        ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
      run: |
        # ARM64
        export CC=aarch64-linux-android28-clang
        export CXX=aarch64-linux-android28-clang++
        export GOOS=android GOARCH=arm64
        uv run task build goneonize --smart
        
        # ARMv7
        export CC=armv7a-linux-androideabi28-clang
        export CXX=armv7a-linux-androideabi28-clang++
        export GOOS=android GOARCH=arm
        uv run task build goneonize --smart
        
        # x86_64
        export CC=x86_64-linux-android28-clang
        export CXX=x86_64-linux-android28-clang++
        export GOOS=android GOARCH=amd64
        uv run task build goneonize --smart
        
        # x86
        export CC=i686-linux-android28-clang
        export CXX=i686-linux-android28-clang++
        export GOOS=android GOARCH=386
        uv run task build goneonize --smart
      continue-on-error: true
    - name: Upload Android artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Android
        path: neonize/*.so

  zig:
    needs: bump-version
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
        fetch-tags: true
    - uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - uses: mlugg/setup-zig@v2
    - name: Install uv
      uses: astral-sh/setup-uv@v5
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          **/.venv
        key: ${{ runner.os }}-${{ hashFiles('**/uv.lock') }}
    - name: Install dependencies
      run: |
        uv sync --dev
        uv run task version neonize --set-version ${{ needs.bump-version.outputs.new_version }}
        uv run task version goneonize --set-version ${{ needs.bump-version.outputs.new_version }}
    - name: Build with Zig
      env:
        CGO_ENABLED: 1
      run: |
        mkdir LIBS
        
        # Windows AMD64
        export GOOS=windows GOARCH=amd64
        export CC="zig cc -target x86_64-windows"
        uv run task build goneonize --smart
        uv build && uv run task repack
        mv neonize/*.dll LIBS/
        
        # Windows ARM64
        export GOOS=windows GOARCH=arm64
        export CC="zig cc -target aarch64-windows"
        uv run task build goneonize --smart
        uv build && uv run task repack
        mv neonize/*.dll LIBS/
        
        # Linux x86
        export GOOS=linux GOARCH=386
        export CC="zig cc -target x86-linux"
        uv run task build goneonize --smart
        uv build && uv run task repack
        mv neonize/*.so LIBS/
        cp dist/*.whl LIBS/
      continue-on-error: true
    - name: Upload Zig artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Zig
        path: LIBS/*

  linux:
    needs: bump-version
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
        fetch-tags: true
    - uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Install system dependencies
      run: sudo apt update && sudo apt install -y gcc-aarch64-linux-gnu gcc-riscv64-linux-gnu gcc-s390x-linux-gnu
    - name: Install uv
      uses: astral-sh/setup-uv@v5
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          **/.venv
        key: ${{ runner.os }}-${{ hashFiles('**/uv.lock') }}
    - name: Install dependencies
      run: |
        uv sync --dev
        uv run task version neonize --set-version ${{ needs.bump-version.outputs.new_version }}
        uv run task version goneonize --set-version ${{ needs.bump-version.outputs.new_version }}
    - name: Build Linux binaries
      env:
        CGO_ENABLED: 1
      run: |
        mkdir LIBS
        
        # x86_64
        uv run task build goneonize --smart
        uv build && uv run task repack
        mv neonize/*.so LIBS/
        
        # ARM64
        export GOOS=linux GOARCH=arm64
        export CC=aarch64-linux-gnu-gcc CXX=aarch64-linux-gnu-cpp
        uv run task build goneonize --smart
        uv build && uv run task repack
        mv neonize/*.so LIBS/
        
        # RISCV64
        export GOOS=linux GOARCH=riscv64
        export CC=riscv64-linux-gnu-gcc CXX=riscv64-linux-gnu-cpp
        uv run task build goneonize --smart
        mv neonize/*.so LIBS/
        
        # s390x
        export GOOS=linux GOARCH=s390x
        export CC=s390x-linux-gnu-gcc CXX=s390x-linux-gnu-cpp
        uv run task build goneonize --smart
        uv build && uv run task repack
        mv neonize/*.so LIBS/
        cp dist/*.whl LIBS/
      continue-on-error: true
    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Linux
        path: LIBS/*

  darwin:
    needs: bump-version
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
        fetch-tags: true
    - uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Install uv
      uses: astral-sh/setup-uv@v5
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          **/.venv
        key: ${{ runner.os }}-${{ hashFiles('**/uv.lock') }}
    - name: Install dependencies
      run: |
        uv sync --dev
        uv run task version neonize --set-version ${{ needs.bump-version.outputs.new_version }}
        uv run task version goneonize --set-version ${{ needs.bump-version.outputs.new_version }}
    - name: Build macOS binaries
      env:
        CGO_ENABLED: 1
        PATH: "/Users/runner/.local/bin:${PATH}"
      run: |
        mkdir LIBS
        
        # AMD64
        export GOOS=darwin GOARCH=amd64
        export CC=clang CXX=clang++
        uv run task build goneonize --smart
        uv build && uv run task repack
        mv neonize/*.dylib LIBS/
        
        # ARM64
        export GOOS=darwin GOARCH=arm64
        uv run task build goneonize --smart
        uv build && uv run task repack
        mv neonize/*.dylib LIBS/
        cp dist/*.whl LIBS/
      continue-on-error: true
    - name: Upload Darwin artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Darwin
        path: LIBS/*

  release:
    needs: [bump-version, android, zig, linux, darwin]
    runs-on: ubuntu-latest
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        merge-multiple: true
        path: sharedlib
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.bump-version.outputs.new_version }}
        files: |
          sharedlib/**/*.so
          sharedlib/**/*.dll
          sharedlib/**/*.dylib
          sharedlib/**/*.whl
        generate_release_notes: true
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Install uv
      uses: astral-sh/setup-uv@v5
    - name: Publish to PyPI
      if: ${{ env.UV_PUBLISH_TOKEN != '' }}
      run: uv build && uv publish
      env:
        UV_PUBLISH_TOKEN: ${{ secrets.PYPI_TOKEN }}